<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.css" integrity="sha512-wJgJNTBBkLit7ymC6vvzM1EcSWeM9mmOu+1USHaRBbHkm6W9EgM0HY27+UtUaprntaYQJF75rc8gjxllKs5OIQ==" crossorigin="anonymous" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.js" integrity="sha512-zlWWyZq71UMApAjih4WkaRpikgY9Bz1oXIW5G0fED4vk14JjGlQ1UmkGM392jEULP8jbNMiwLWdM8Z87Hu88Fw==" crossorigin="anonymous"></script>

	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

	<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
	<script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>

	<script src="https://xembook.github.io/nem2-browserify/symbol-sdk-pack-2.0.4.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ejs/ejs.min.js"></script>

	<script src="js/config.js"></script>
	<script src="js/symapp.js"></script>
<style>
.jq-toast-wrap {
    width:350px;
}

.div-list {
	list-style-type: disc; /* ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’è¨­å®š */
	margin: 0; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ */
	padding: 0; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ */
}

.chapter {
	border: 1px solid #ff0000;
	box-sizing: border-box;
	margin: 1px;
	display: list-item; /* ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã¨ã—ã¦è¡¨ç¤º */
	margin-left: 1.4em; /* å·¦ãƒãƒ¼ã‚¸ãƒ³ã‚’è¨­å®šã—ã¦ã€ãƒãƒ¼ã‚«ãƒ¼ã®ä½ç½®ã‚’èª¿æ•´ */
}

.indented {
    padding-left: 20px;
}

.address { font-size : 9pt ; }
</style>
</head>
<body>
<div class="container">
<h1>ã¿ã‚“ãªã®æ†²ç« </h1>
<h4>æ§‹é€  Structure</h4>
<div id="output" class="div-list"></div>
<hr>
<h4>å±¥æ­´ History</h4>
<ul id="history"></ul>
<hr>
<h4>QRs</h4>
<h5>ãƒ‰ãƒ©ãƒ•ãƒˆç‰ˆ Draft Page</h5>
<div id="qr_draft"></div>
<br>
<h5>ç™ºè¡Œç‰ˆ Publish Page</h5>
<div id="qr_publish"></div>
</div>
<br>
<br>
<!-- ä¿®æ­£ææ¡ˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="modal_update" tabindex="-1" role="dialog">
<div class="modal-dialog" role="document"><div class="modal-content">

	<div class="modal-header">
		<h5 class="modal-title">ä¿®æ­£ææ¡ˆ</h5>
		<button type="button" class="close" data-dismiss="modal" aria-label="é–‰ã˜ã‚‹"><span aria-hidden="true">&times;</span></button>
	</div>
	<div class="modal-body">
		<div>
			<label><b>ææ¡ˆå…ˆã‚¢ãƒ‰ãƒ¬ã‚¹</b><br></label>
			<div class="address" id="modal_update_next"></div>
			<br>
			<label><b>ä¿®æ­£å¯¾è±¡ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</b><br></label>
			<div id="modal_update_doc"></div>
			<br>
			<label><b>ä¿®æ­£ææ¡ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</b><br></label>
			<textarea class="form-control keyarea" id="modal_update_textarea" rows="2"></textarea>
			<br>
		</div>
	</div>
	<div class="modal-footer">
		<button type="button" class="btn btn-primary" onclick="okModalUpdate('sss')">
			<span id="spinner_update_sss" class="collapse spinner-border spinner-border-sm" role="status"></span>
			SSSã§ææ¡ˆ
		</button>
		<button type="button" class="btn btn-primary" onclick="okModalUpdate('alice')">
			<span id="spinner_update_alice" class="collapse spinner-border spinner-border-sm" role="status"></span>
			aLiceã§ææ¡ˆ
		</button>
		<button type="button" class="btn btn-default" data-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
	</div><!-- /.modal-footer -->
</div></div><!-- /.modal-content --><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- è¿½è¨˜ææ¡ˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="modal_append" tabindex="-1" role="dialog">
<div class="modal-dialog" role="document"><div class="modal-content">

	<div class="modal-header">
		<h5 class="modal-title">è¿½è¨˜ææ¡ˆ</h5>
		<button type="button" class="close" data-dismiss="modal" aria-label="é–‰ã˜ã‚‹"><span aria-hidden="true">&times;</span></button>
	</div>
	<div class="modal-body">
		<div>
			<label><b>ææ¡ˆå…ˆã‚¢ãƒ‰ãƒ¬ã‚¹</b><br></label>
			<div class="address" id="modal_append_next"></div>
			<br>
			<label><b>è¿½è¨˜ææ¡ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</b><br></label>
			<div id="modal_append_doc"></div>
			<textarea class="form-control keyarea" id="modal_append_textarea" rows="2"></textarea>
			<br>
		</div>
	</div>
	<div class="modal-footer">
		<button type="button" class="btn btn-primary" onclick="okModalAppend('sss')">
			<span id="spinner_append_sss" class="collapse spinner-border spinner-border-sm" role="status"></span>
			SSSã§ææ¡ˆ
		</button>
		<button type="button" class="btn btn-primary" onclick="okModalAppend('alice')">
			<span id="spinner_append_alice" class="collapse spinner-border spinner-border-sm" role="status"></span>
			aLiceã§ææ¡ˆ
		</button>
		<button type="button" class="btn btn-default" data-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
	</div><!-- /.modal-footer -->
</div></div><!-- /.modal-content --><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- æŠ•ç¥¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="modal_vote" tabindex="-1" role="dialog">
<div class="modal-dialog" role="document"><div class="modal-content">

	<div class="modal-header">
		<h5 class="modal-title">æŠ•ç¥¨</h5>
		<button type="button" class="close" data-dismiss="modal" aria-label="é–‰ã˜ã‚‹"><span aria-hidden="true">&times;</span></button>
	</div>
	<div class="modal-body">
		<div>
			<label><b>æŠ•ç¥¨ãƒ¢ã‚¶ã‚¤ã‚¯</b><br></label>
			<div class="address" id="modal_vote_mosaic"></div>
			<br>
			<label><b>è³›æˆã‚¢ãƒ‰ãƒ¬ã‚¹</b><br></label>
			<div class="address" id="modal_vote_agree"></div>
			<br>
			<label><b>åå¯¾ã‚¢ãƒ‰ãƒ¬ã‚¹</b><br></label>
			<div class="address" id="modal_vote_disagree"></div>
		</div>
	</div>
	<div class="modal-footer">
		<label><b>è³›æˆ</b><br></label>
		<button type="button" class="btn btn-primary" onclick="okModalvote('modal_vote_agree','sss')">
			<span id="spinner_agree_sss" class="collapse spinner-border spinner-border-sm" role="status"></span>
			SSSã§è³›æˆ
		</button>
		<button type="button" class="btn btn-primary" onclick="okModalvote('modal_vote_agree','alice')">
			<span id="spinner_agree_alice" class="collapse spinner-border spinner-border-sm" role="status"></span>
			aLiceã§è³›æˆ
		</button>
		
	</div><!-- /.modal-footer -->
	<div class="modal-footer">
		<label><b>åå¯¾</b><br></label>

		<button type="button" class="btn btn-primary" onclick="okModalvote('modal_vote_disagree','sss')">
			<span id="spinner_disagree_sss" class="collapse spinner-border spinner-border-sm" role="status"></span>
			SSSã§åå¯¾
		</button>
		<button type="button" class="btn btn-primary" onclick="okModalvote('modal_vote_disagree','alice')">
			<span id="spinner_disagree_alice" class="collapse spinner-border spinner-border-sm" role="status"></span>
			aLiceã§åå¯¾
		</button>
	</div><!-- /.modal-footer -->
	<div class="modal-footer">
		
		<button type="button" class="btn btn-default" data-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
	</div><!-- /.modal-footer -->
</div></div><!-- /.modal-content --><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- è­°æ±ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="modal_decision" tabindex="-1" role="dialog">
<div class="modal-dialog" role="document"><div class="modal-content">

	<div class="modal-header">
		<h5 class="modal-title">è­°æ±º</h5>
		<button type="button" class="close" data-dismiss="modal" aria-label="é–‰ã˜ã‚‹"><span aria-hidden="true">&times;</span></button>
	</div>
	<div class="modal-body">
		<div>

			<label><b>ææ¡ˆã‚¢ãƒ‰ãƒ¬ã‚¹</b><br></label>
			<div id="modal_decision_address"></div>
			<br>
			<label><b>å¯¾è±¡ãƒãƒƒã‚·ãƒ¥</b><br></label>
			<textarea  class="form-control keyarea" id="modal_decision_hash" rows="2"></textarea>


		</div>
	</div>
	<div class="modal-footer">
		<button type="button" class="btn btn-primary" onclick="okModalDecision('sss')">
			<span id="spinner_decision_sss" class="collapse spinner-border spinner-border-sm" role="status"></span>
			SSSã§è­°æ±º
		</button>
		<button type="button" class="btn btn-primary" onclick="okModalDecision('alice')">
			<span id="spinner_decision_alice" class="collapse spinner-border spinner-border-sm" role="status"></span>
			aLiceã§è­°æ±º
		</button>
		<button type="button" class="btn btn-default" data-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
	</div><!-- /.modal-footer -->
</div></div><!-- /.modal-content --><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script>
const CONFIRMED_TOKEN_ID = "54F9D50A6D73E426"; //ç¥¨æ±ºãƒˆãƒ¼ã‚¯ãƒ³
const VOTE_TOKEN_ID = "55CEF6ACA47C09BC"; //æŠ•ç¥¨ãƒˆãƒ¼ã‚¯ãƒ³
const INIT_DOCUMENT_ID = "338DCC41E690DB6A7932393B32149872D534603A9D49CD6E4F64111E98BAF21B"; //åˆæœŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

const sym = require("/node_modules/symbol-sdk");
const qr  = require("/node_modules/symbol-qr-library");
const history = document.getElementById("history");

//TA6EAATQMNJM4QV4ARM3DVWGSZULWBDB7HGEVPY
//C9E741092833FEA79D7DB7DC839506BBEB6704631DB9B4D59C60A02BF6B0200C
const aliceKey = "A4EC288C8566B8D3C2DC02712C66B368813959E02D619AB40A523066278D6506";
let alice;

const CONFIG_SYMBOL_APPLICATION = {
	nodes:TEST_NODES,       //ãƒãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ config.jså†…ã«è¨˜è¼‰
	selectNodeCount:3,      //åŒæœŸç¢ºèªã®ãŸã‚ã«æ¥ç¶šã™ã‚‹ãƒãƒ¼ãƒ‰æ•°
	timeout:1800,           //ãƒãƒ¼ãƒ‰æ¥ç¶šå¾…æ©Ÿæ™‚é–“ ãƒŸãƒªç§’
	heightDiffThreshold: 1, // åŒæœŸåˆ¤æ–­ãƒ–ãƒ­ãƒƒã‚¯é«˜å·®
	retryCount:30,          //æœ€å¤§å†æ¥ç¶šå›æ•°
	mainnet:"MAIN_NET",
	testnet:"TEST_NET"
};

let currentDocument = "null document";
let currentAddress;
let txMetaHash;
let networkType;
let generationHash;
let epochAdjustment;
let nodeUrl;
let confirmId;
let transactionId;
let voteId;

startSymbolApplication(

	CONFIG_SYMBOL_APPLICATION,
	
	//onReady
	async function(node){
		console.log("select : " + node.url);
		$.toast({heading: 'Select Node',text: node.url,showHideTransition: 'plain',icon: 'info',});
		nodeUrl = node.url;
		networkType = sym.NetworkType[CONFIG_SYMBOL_APPLICATION[node.network.identifier]];
		generationHash = node.network.generationHashSeed;
		epochAdjustment = node.network.epochAdjustment.slice(0,-1);

		//ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯
		const params = new URLSearchParams(document.location.search.substring(1));
		const reset = params.get("reset");
		confirmId = getParams(params,"confirm_id",CONFIRMED_TOKEN_ID);
		transactionId = getParams(params,"tx_id",INIT_DOCUMENT_ID);
		voteId = getParams(params,"vote_id",VOTE_TOKEN_ID);

		networkType = sym.NetworkType[CONFIG_SYMBOL_APPLICATION[node.network.identifier]];
		alice = sym.Account.createFromPrivateKey(aliceKey,networkType);
		res = await nodeFetch(node.url + `/transactions/confirmed/${transactionId}` )
		const tx = JSON.parse(res);
		const message = sym.Convert.uint8ToUtf8(sym.Convert.hexToUint8(tx.transaction.message).slice(1))

		var generatedDocument = await ejs.render(message, data,{ async: true });
		const olElement = document.getElementById('output');

		olElement.innerHTML = decodeHTMLEntities(generatedDocument);
		setSocket(currentWebsocket);


		const qrDraft = new QRCode(document.getElementById('qr_draft'), {
			text: location.href,
			width: 256, height: 256
		});

		const qrPublish = new QRCode(document.getElementById('qr_publish'), {
			text: `https://${location.host}/minken/view.html${location.search}`,
			width: 256, height: 256
		});

	},

	// onStatusChange çŠ¶æ…‹å¤‰æ›´é€šçŸ¥
	async function(event){
		console.log(event.name + " : " + event.error + " : " + event.targetNode);
	},

	// onPhysicalMessage QRå—ä¿¡æ™‚
	async function(event){

		console.log(event);
		$.toast({heading: 'Scan',text:event ,showHideTransition: 'plain',icon: 'info',});
		$('#modal_qr_scan').modal('hide');
	},

	async function(event     ){
		console.log(event);
		if(event.topic.indexOf("confirmed") === 0){
			$('#spinner_agree_sss').collapse('hide');
			$('#spinner_agree_alice').collapse('hide');
			$('#spinner_disagree_sss').collapse('hide');
			$('#spinner_disagree_alice').collapse('hide');
			$('#spinner_decision_sss').collapse('hide');
			$('#spinner_decision_alice').collapse('hide');				
			$('#spinner_update_sss').collapse('hide');
			$('#spinner_update_alice').collapse('hide');				
			$('#spinner_append_sss').collapse('hide');
			$('#spinner_append_alice').collapse('hide');				
			$("#modal_vote").modal("hide");
			$("#modal_decision").modal("hide");
			$("#modal_update").modal("hide");
			$("#modal_append").modal("hide");
			
			alert("ææ¡ˆå…ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®çŠ¶æ…‹ã«æ›´æ–°ãŒã‚ã‚Šã¾ã—ãŸã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚")
		} 
	},	//onSocketMessage ã‚½ã‚±ãƒƒãƒˆå—ä¿¡æ™‚
	async function(nodeSocket){

		setSocket(currentWebsocket);

	},	//onSocketResumed ã‚½ã‚±ãƒƒãƒˆæ¥ç¶šå›å¾©æ™‚
	async function(){/* onVisible ç”»é¢ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å›å¾©æ™‚     */}
);

function getParams(params,key,defaultValue){
	let item = params.get(key);
	if(item === null ){
		item = defaultValue;
	}
	return item;
}

function setSocket(nodeSocket){
	socketSend(nodeSocket,'block');
}

// EJSã§ç”Ÿæˆã•ã‚ŒãŸHTML
function decodeHTMLEntities(html) {
	const textarea = document.createElement("textarea");
	textarea.innerHTML = html;
	return textarea.value;
}

function addHistory(item,isIndent) {
	// æ–°ã—ã„ <li> è¦ç´ ã‚’ä½œæˆ
	var newItem = document.createElement("li");
//	var textNode = document.createTextNode(item);

	newItem.innerHTML = item;
//	newItem.appendChild(textNode);

	if(isIndent){
		newItem.classList.add("indented");
	}
	// <ul> è¦ç´ ã‚’å–å¾—ã—ã€æ–°ã—ã„ <li> è¦ç´ ã‚’è¿½åŠ 
	var list = document.getElementById("history");
	list.appendChild(newItem);
}

async function getCurrentDocument(doc,mosaicId,agree,disagree){

	//nextãŒç„¡åŠ¹ãªã®ã§ç¾åœ¨ã®docã‚’èª¿ã¹ã‚‹
	let resDoc;

	//è³›æˆç¥¨ã®ã‚«ã‚¦ãƒ³ãƒˆ
	let agreeAmount = 0;
	try{
		const resAgree = await nodeFetch(nodeUrl + `/accounts/${agree}`);
		agreeAmount = JSON.parse(resAgree).account.mosaics.filter(mosaic=>mosaic.id === mosaicId)[0].amount;
	}catch{}

	//åå¯¾ç¥¨ã®ã‚«ã‚¦ãƒ³ãƒˆ
	let disAgreeAmount = 0;
	try{

		const resDisAgree = await nodeFetch(nodeUrl + `/accounts/${disagree}`);
		disAgreeAmount = JSON.parse(resDisAgree).account.mosaics.filter(mosaic=>mosaic.id === mosaicId)[0].amount;
	}catch{}

	if(agreeAmount > disAgreeAmount){

		//å¯æ±º
		resDoc = doc;
		addHistory(`è­°æ±ºï¼šè³›æˆ:${agreeAmount},åå¯¾:${disAgreeAmount}â†’â­•å¯æ±º`);

	}else{

		//å¦æ±ºã€ã‚ã‚‹ã„ã¯åŒæ•°ç¥¨
		resDoc = currentDocument;
		addHistory(`è­°æ±ºï¼šè³›æˆ:${agreeAmount},åå¯¾:${disAgreeAmount}â†’âŒå¦æ±º`);
	}
	return resDoc;
}

function putTransaction(rawAddress,mosaics,message,callback){

	const address = sym.Address.createFromRawAddress(rawAddress);
	
	tx3 = sym.TransferTransaction.create(
		sym.Deadline.create(epochAdjustment),
		address,
		mosaics,
		message,
		networkType
	).setMaxFee(100);

	callback(tx3,address);
	
	socketSend(currentWebsocket,'status/'   + address.plain());
	socketSend(currentWebsocket,'confirmedAdded/'   + address.plain());
	socketSend(currentWebsocket,'unconfirmedAdded/' + address.plain());	

/*
	const payload = tx3.serialize();
	location.href = `alice://sign?data=${payload}&type=request_sign_transaction&node=${sym.Convert.utf8ToHex(nodeUrl)}&method=announce&deadline=3600`;

	window.SSS.setTransaction(tx3);
	window.SSS.requestSign().then((signedTx3) => {
		// announce
		nodeFetch(nodeUrl + "/transactions","PUT",{"payload": signedTx3.payload }).then(res=>console.log(res));
		socketSend(currentWebsocket,'status/'   + address.plain());
		socketSend(currentWebsocket,'confirmedAdded/'   + address.plain());
		socketSend(currentWebsocket,'unconfirmedAdded/' + address.plain());	
	})
*/
//	signedTx3 = alice.sign(tx3,generationHash);
}

const callbackSSS = function(tx3,address){
	window.SSS.setTransaction(tx3);
	window.SSS.requestSign().then((signedTx3) => {
		// announce
		nodeFetch(nodeUrl + "/transactions","PUT",{"payload": signedTx3.payload }).then(res=>console.log(res));
	});

}

const callbackAlice = function(tx3,address){

	const payload = tx3.serialize();
	location.href = `alice://sign?data=${payload}&type=request_sign_transaction&node=${sym.Convert.utf8ToHex(nodeUrl)}&method=announce&deadline=3600`;
//	nodeFetch(nodeUrl + "/transactions","PUT",{"payload": signedTx3.payload }).then(res=>console.log(res));
}

const callbackSelf = function(tx3,address){
	signedTx3 = alice.sign(tx3,generationHash);
	nodeFetch(nodeUrl + "/transactions","PUT",{"payload": signedTx3.payload }).then(res=>console.log(res));
}

const data2 = {

	update : async function(next,doc,mosaicId,agree,disagree){
		addHistory(`ğŸ“£æŠ•ç¥¨å—ä»˜ä¸­ã®æ”¹å–„ææ¡ˆãŒã‚ã‚Šã¾ã™ <button onclick='showModalDecision("${currentAddress}","${txMetaHash}")'>è­°æ±º</button>`,true);
		addHistory(doc,true);
//		addHistory(`<button onclick='vote("${agree}")'>è³›æˆ</button> ` + agree,true);
//		addHistory(`<button onclick='vote("${disagree}")'>åå¯¾</button> ` + disagree,true);
		addHistory(`<button onclick='showModalVote("${agree}","${disagree}","${mosaicId}")'>æŠ•ç¥¨</button>`,true);
	},
	append : async function(next){
	}
};

const data = {

	update : async function(next,doc,mosaicId,agree,disagree){

		addHistory("ğŸ”æ¤œè¨¼: " + doc);
		await checkVoting(next);
		currentDocument = await getCurrentDocument(doc,mosaicId,agree,disagree);

		let confirmedHash;
		try{

			confirmedHash = await getConfirmedHash(next);
			if(confirmedHash === false){
				return false;
			}
		}catch(error){

			//æ¬¡æœŸä¿®æ­£ææ¡ˆã«æ‰¿èªæ¸ˆã¿ãƒˆãƒ¼ã‚¯ãƒ³ç„¡ã—ã®ãŸã‚ã€ç¾çŠ¶æ¡æŠã•ã‚Œã¦ã„ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®è¡¨ç¤º
//			v23ã¾ã§ã“ã“ã«ã‚ã£ãŸ
//			currentDocument = await getCurrentDocument(doc,mosaicId,agree,disagree);
			return getUpdateDocument(next);
		}

		let message = await getMessage(confirmedHash);
		if(!message){
			return false;
		}

		//ç¾çŠ¶ã®æ¡æŠãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æŠŠæ¡ v23ã¾ã§ã“ã“ã«ã‚ã£ãŸ
//		currentDocument = await getCurrentDocument(doc,mosaicId,agree,disagree);

		//æ¬¡æœŸä¿®æ­£ææ¡ˆãŒæ‰¿èªã•ã‚Œã¦ã„ã‚‹
		try{

			//æ¬¡æœŸä¿®æ­£ææ¡ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå¯æ±ºã§æ‰¿èªã•ã‚Œã¦ã„ã‚‹ã€‚
			const renderedMessage = await ejs.render(message ,data,{ async: true });
			return decodeHTMLEntities("<div class='chapter'>" + renderedMessage + "</div>") ;
			
		}catch(error){

			//æ¬¡æœŸä¿®æ­£ææ¡ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå¦æ±ºã§æ‰¿èªã•ã‚Œã¦ã„ã‚‹ã€‚
			return getUpdateDocument(next);
		}
	},
	append : async function(next){

		addHistory(`ğŸ”è¿½è¨˜æ¤œè¨¼: <span class="address">${next}</span> `);
		checkVoting(next);

		let confirmedHash;
		try{
			confirmedHash = await getConfirmedHash(next);
			if(confirmedHash === false){
				return false;
			}

		}catch(error){
			//ç¥¨æ±ºãƒˆãƒ¼ã‚¯ãƒ³ãŒã¾ã æŠ•ã’ã‚‰ã‚Œã¦ã„ãªã„çŠ¶æ…‹ã€ã‚ã‚‹ã„ã¯æŠ•ã’ã‚‰ã‚ŒãŸãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«ææ¡ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒãƒƒã‚·ãƒ¥å€¤ãŒæŒ‡å®šã•ã‚Œã„ã¦ã„ãªã„å ´åˆã€‚
			return getAppendDocument(next);
		}

		let message = await getMessage(confirmedHash);
		if(!message){
			return false;
		}

		try{
			//å¦æ±ºã€ç„¡åŠ¹æ™‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
			currentDocument = "[ä¸æ¡æŠè¿½è¨˜ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ]";
			const renderedMessage = await ejs.render(message ,data,{ async: true });
			return decodeHTMLEntities(renderedMessage) ;
			
		}catch(error){

			//è¿½è¨˜ææ¡ˆã¯ã¾ã æ¡æŠã•ã‚Œã¦ã„ãªã„çŠ¶æ…‹
			return getAppendDocument(next);
		}
	}
};

//æŠ•ç¥¨å—ä»˜ä¸­ã®ææ¡ˆãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
async function checkVoting(next){

	try{
		//æ‰¿èªãƒˆãƒ¼ã‚¯ãƒ³ãŒæŠ•ã’ã‚‰ã‚Œã¦ã„ãªã„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã¿å–å¾—
		const resAgree = await nodeFetch(nodeUrl + `/accounts/${next}`);

		let confirmedAmount;
		if(JSON.parse(resAgree).account.mosaics.length === 0){
			confirmedAmount = 0;
		}else{
		
			confirmedAmount = JSON.parse(resAgree).account.mosaics.filter(mosaic=>mosaic.id === confirmId)[0].amount;
		}

		if(confirmedAmount <= 0){
			//æ‰¿èªãƒˆãƒ¼ã‚¯ãƒ³ã¨å…±ã«è¨˜ã•ã‚ŒãŸæ‰¿èªæ¸ˆã¿ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—
			const resTx = await nodeFetch(nodeUrl + `/transactions/confirmed?order=desc&recipientAddress=${next}`)
			txes = JSON.parse(resTx).data;
			
			for(const tx of txes){

				try{
					const msg = sym.Convert.uint8ToUtf8(sym.Convert.hexToUint8(tx.transaction.message).slice(1)).trim();
					currentAddress = next;
					txMetaHash = tx.meta.hash;
					const renderedMessage = await ejs.render(msg ,data2,{ async: true });
				}catch{}
			}
		}
	}catch(error){}
}

async function getConfirmedHash(next){

	try{
		//æ‰¿èªãƒˆãƒ¼ã‚¯ãƒ³ã¨å…±ã«è¨˜ã•ã‚ŒãŸæ‰¿èªæ¸ˆã¿ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—
		const resFinalizedTx = await nodeFetch(nodeUrl + `/transactions/confirmed?transferMosaicId=${confirmId}&order=desc&recipientAddress=${next}`)
		const finalizedTx = JSON.parse(resFinalizedTx).data[0];
		if(finalizedTx.transaction.message === undefined){
			addHistory("âš ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼ã€‘:æ‰¿èªãƒˆãƒ¼ã‚¯ãƒ³ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ·»ä»˜ã•ã‚Œã¦ã„ã¾ã›ã‚“");
			return false;
		}

		confirmedHash = sym.Convert.uint8ToUtf8(sym.Convert.hexToUint8(finalizedTx.transaction.message).slice(1)).trim();

		if(confirmedHash.length !== 64){
			addHistory("âš ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼ã€‘:æ‰¿èªãƒˆãƒ¼ã‚¯ãƒ³ã«æ·»ä»˜ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒä¸æ­£ã§ã™");
			return false;
		}
	}catch(error){
		//æ¬¡æœŸä¿®æ­£å€™è£œã«ãƒˆãƒ¼ã‚¯ãƒ³ãŒæŠ•ã’ã‚‰ã‚Œã¦ã„ãªã„ã ã‘ã§ã€ã‚¨ãƒ©ãƒ¼ã§ã¯ãªã„ã€‚ä¸Šè¨˜return falseã¨ã¯åŒºåˆ¥ã™ã‚‹ã“ã¨ã€‚
		throw error;
	}
	return confirmedHash;
}

async function getMessage(confirmedHash){

	try{

		//æ‰¿èªæ¸ˆã¿ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§ææ¡ˆã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
		const resConfirmedTx = await nodeFetch(nodeUrl + "/transactions/confirmed/" + confirmedHash );
		const confirmedTx = JSON.parse(resConfirmedTx);
		message = sym.Convert.uint8ToUtf8(sym.Convert.hexToUint8(confirmedTx.transaction.message).slice(1))

	}catch(error){

		addHistory("âš ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼ã€‘:æ‰¿èªãƒˆãƒ¼ã‚¯ãƒ³ã®æŒ‡å®šã—ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
		return false;
	}
	return message;
}

function getUpdateDocument(next){
	addHistory("<b>æ¡æŠ</b>: " + currentDocument);
	return `<div class='chapter'>${currentDocument}<br><button onclick='showModalUpdate("${next}","${currentDocument}")'>â†‘ ä¿®æ­£ææ¡ˆ</button> <span class="address">${next}</span></div>`;
}

function getAppendDocument(next){
	return `<br><button onclick='showModalAppend("${next}")'>â— è¿½è¨˜ææ¡ˆ</button> <span class="address">${next}</span>`;
}

function buildDocument(textarea){

	const docTextarea = document.getElementById(textarea);
	const updateAccount = sym.Account.generateNewAccount(networkType);
	const agreeAccount = sym.Account.generateNewAccount(networkType);
	const disagreeAccount = sym.Account.generateNewAccount(networkType);
	const appendAccount = sym.Account.generateNewAccount(networkType);

const proposalDocument = `
<%= await update(
	"${updateAccount.address.plain()}",
	"${docTextarea.value}",
	"${voteId}",
	"${agreeAccount.address.plain()}",
	"${disagreeAccount.address.plain()}"
) %>
<%= await append("${appendAccount.address.plain()}") %>
`;//`

	return proposalDocument;
}
/*
$('#modal_qr_scan').on('hide.bs.modal', function (e) {
	stopVideo();		
	clearRect();
});
*/


function showModalUpdate(next,updateDoc){
	const textarea = document.getElementById("modal_update_doc");
	textarea.textContent = updateDoc;

	const nextAddress = document.getElementById("modal_update_next");
	nextAddress.textContent = next;
	$("#modal_update").modal("show");
}

function showModalAppend(next,appendDoc){

	const nextAddress = document.getElementById("modal_append_next");
	nextAddress.textContent = next;
	$("#modal_append").modal("show");
}

function showModalVote(agree,disagree,mosaicId){

	document.getElementById("modal_vote_agree").textContent = agree;
	document.getElementById("modal_vote_disagree").textContent = disagree;
	document.getElementById("modal_vote_mosaic").textContent = mosaicId;
	$("#modal_vote").modal("show");
}

function showModalDecision(address,hash){

	document.getElementById("modal_decision_address").textContent = address;
	document.getElementById("modal_decision_hash").textContent = hash;
	$("#modal_decision").modal("show");
}

function getWalletCallback(walletType){

	let wallet;
	if(walletType === 'sss'){
		callback = callbackSSS;
	}else if(walletType === 'alice'){

		callback = callbackAlice;
	}else{

		callback = callbackSelf;
	}
	return callback;
}
function okModalvote(id,walletType){

	const address = document.getElementById(id).textContent ;
	const callback = getWalletCallback(walletType);
	putTransaction(
		address,
		[new sym.Mosaic(new sym.MosaicId(voteId), sym.UInt64.fromUint(1))],
		sym.EmptyMessage,
		callback
	);

	if(walletType === "sss"){
		if(id.indexOf("disagree")>=0){
			$('#spinner_disagree_sss').collapse('show');
		}else{
			$('#spinner_agree_sss').collapse('show');
		}
	}else{
		if(id.indexOf("disagree")>=0){

			$('#spinner_disagree_alice').collapse('show');	
		}else{

			$('#spinner_agree_alice').collapse('show');
		}
	}
}

function okModalDecision(walletType){

	const callback = getWalletCallback(walletType);
	const address = document.getElementById("modal_decision_address").textContent ;
	const hash = document.getElementById("modal_decision_hash").textContent ;
	putTransaction(
		address,
		[new sym.Mosaic(new sym.MosaicId(confirmId), sym.UInt64.fromUint(1))],
		sym.PlainMessage.create(hash),
		callback
	);
	if(walletType === "sss"){
		$('#spinner_decision_sss').collapse('show');
	}else{

		$('#spinner_decision_alice').collapse('show');	
	}
//	$("#modal_decision").modal("hide");

}

function okModalUpdate(walletType){

	const nextAddress = document.getElementById("modal_update_next");
	const updateDocument = buildDocument("modal_update_textarea");
	const callback = getWalletCallback(walletType);
	putTransaction(nextAddress.textContent,[],sym.PlainMessage.create(updateDocument),callback);
	if(walletType === "sss"){
		$('#spinner_update_sss').collapse('show');
	}else{

		$('#spinner_update_alice').collapse('show');	
	}
	//	$("#modal_update").modal("hide");
}

function okModalAppend(walletType){

	const callback = getWalletCallback(walletType);
	const nextAddress = document.getElementById("modal_append_next");
	const appendDocument = buildDocument("modal_append_textarea");
	putTransaction(nextAddress.textContent,[],sym.PlainMessage.create(appendDocument),callback);
//	$("#modal_append").modal("hide");
if(walletType === "sss"){
		$('#spinner_append_sss').collapse('show');
	}else{

		$('#spinner_append_alice').collapse('show');	
	}
}


</script>
</body>
</html>
