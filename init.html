<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.css" integrity="sha512-wJgJNTBBkLit7ymC6vvzM1EcSWeM9mmOu+1USHaRBbHkm6W9EgM0HY27+UtUaprntaYQJF75rc8gjxllKs5OIQ==" crossorigin="anonymous" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.js" integrity="sha512-zlWWyZq71UMApAjih4WkaRpikgY9Bz1oXIW5G0fED4vk14JjGlQ1UmkGM392jEULP8jbNMiwLWdM8Z87Hu88Fw==" crossorigin="anonymous"></script>

	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

	<script src="https://xembook.github.io/nem2-browserify/symbol-sdk-pack-2.0.4.js"></script>

	<script src="js/config.js"></script>
	<script src="js/symapp.js"></script>

<style>
.jq-toast-wrap {
    width:250px;
}


.div-list {
	list-style-type: disc; /* リストアイテムのマーカーを設定 */
	margin: 0; /* マージンをリセット */
	padding: 0; /* パディングをリセット */
}

.chapter {
	border: 1px solid #ff0000;
	box-sizing: border-box;
	margin: 1px;
	display: list-item; /* リストアイテムとして表示 */
	margin-left: 1.4em; /* 左マージンを設定して、マーカーの位置を調整 */
}

.indented {
    padding-left: 20px;
}
</style>
</head>

<body>

<div class="container">
<h1>みんなの憲章</h1>
<div id="output" class="div-list"></div>
<hr>
<h4>初期ドキュメント作成ツール</h4>
<ul id="history"></ul>

	<!--h1>8_account.html</h1>
	<button onclick="showModalQR()">スキャン</button>
	<br>
	<b>Address QR</b>
	<div id="signer_address"></div>
	<div id="signer_address_plain"></div>
	<button onclick="showModalAuthForKey()">鍵情報</button-->
</div>



<script>
const CONFIRMED_TOKEN_ID = "193732F8B74E36EF"; //票決トークン
const VOTE_TOKEN_ID = "47E966473AECCC36";      //投票トークン
const INIT_DOCUMENT_ID = "F42CB7AAD44A339765CCC4897175F2AEAD779942F8389F6EFB5E761185503DA9"; //初期ドキュメント
const INIT_ADDRESS = "";



function addHistory(item,isIndent) {
	// 新しい <li> 要素を作成
	var newItem = document.createElement("li");
//	var textNode = document.createTextNode(item);

	newItem.innerHTML = item;
//	newItem.appendChild(textNode);

	if(isIndent){
		newItem.classList.add("indented");
	}
	// <ul> 要素を取得し、新しい <li> 要素を追加
	var list = document.getElementById("history");
	list.appendChild(newItem);
}

let preDoc = "[新規ドキュメント]";
let currentAgree;
let currentDisagree;

let encryptedSignerJSON;
let signerRawAddress;
let signerPublicAccount;
let networkType;
let currencyMosaicId;
let generationHash;
let epochAdjustment;

let nodeUrl;

const ITEM_NAME = "symbolseminar";
const sym = require("/node_modules/symbol-sdk");
const qr  = require("/node_modules/symbol-qr-library");

const history = document.getElementById("history");
function addHistory(item,isIndent) {
	// 新しい <li> 要素を作成
	var newItem = document.createElement("li");
//	var textNode = document.createTextNode(item);
	newItem.innerHTML = item;

//	newItem.appendChild(textNode);

	if(isIndent){
		newItem.classList.add("indented");
	}
	// <ul> 要素を取得し、新しい <li> 要素を追加
	var list = document.getElementById("history");
	list.appendChild(newItem);
}

const CONFIG_SYMBOL_APPLICATION = {
	nodes:TEST_NODES,       //ノードリスト config.js内に記載
	selectNodeCount:3,      //同期確認のために接続するノード数
	timeout:1800,           //ノード接続待機時間 ミリ秒
	heightDiffThreshold: 1, // 同期判断ブロック高差
	retryCount:30,          //最大再接続回数
	mainnet:"MAIN_NET",
	testnet:"TEST_NET"
};

startSymbolApplication(

	CONFIG_SYMBOL_APPLICATION,

	//onReady
	async function(node){
		console.log("select : " + node.url);
		$.toast({heading: 'Select Node',text: node.url,showHideTransition: 'plain',icon: 'info',});
		nodeUrl = node.url;
		networkType = sym.NetworkType[CONFIG_SYMBOL_APPLICATION[node.network.identifier]];
		generationHash = node.network.generationHashSeed;
		epochAdjustment = node.network.epochAdjustment.slice(0,-1);
		currencyMosaicId = node.network.currencyMosaicId.split("'").join("").slice(2);


		//ディープリンク
		const params = new URLSearchParams(document.location.search.substring(1));
		let confirmId = params.get("confirm_id");
		if(confirmId === null ){
			confirmId = CONFIRMED_TOKEN_ID;
		}

		let voteId = params.get("vote_id");
		if(voteId === null ){
			voteId = VOTE_TOKEN_ID;
		}

		networkType = sym.NetworkType[CONFIG_SYMBOL_APPLICATION[node.network.identifier]];

		alice = sym.Account.createFromPrivateKey("C9E741092833FEA79D7DB7DC839506BBEB6704631DB9B4D59C60A02BF6B0200C",networkType);

		address = sym.Account.generateNewAccount(networkType).address;
		updateAccount = sym.Account.generateNewAccount(networkType);
		agreeAccount = sym.Account.generateNewAccount(networkType);
		disagreeAccount = sym.Account.generateNewAccount(networkType);
		appendAccount = sym.Account.generateNewAccount(networkType);


updateDocument = `
<%= await update(
	"${updateAccount.address.plain()}",
	"[新規ドキュメント]",
	"${voteId}",
	"${agreeAccount.address.plain()}",
	"${disagreeAccount.address.plain()}"
) %>
<%= await append("${appendAccount.address.plain()}") %>
`;//`

		console.log(updateDocument);
	
		tx = sym.TransferTransaction.create(
			sym.Deadline.create(epochAdjustment),
			address,[],
			sym.PlainMessage.create(updateDocument),
			networkType
		).setMaxFee(100);
		signedTx = alice.sign(tx,generationHash);

		console.log(signedTx);

		tx2 = sym.TransferTransaction.create(
			sym.Deadline.create(epochAdjustment),
			address,
			[new sym.Mosaic(new sym.MosaicId(confirmId), sym.UInt64.fromUint(1))],
			sym.PlainMessage.create(signedTx.hash),
			networkType
		).setMaxFee(100);
		signedTx2 = alice.sign(tx2,generationHash);

		tx3 = sym.TransferTransaction.create(
			sym.Deadline.create(epochAdjustment),
			agreeAccount.address,
			[new sym.Mosaic(new sym.MosaicId(voteId), sym.UInt64.fromUint(1))],
			sym.PlainMessage.create(signedTx.hash),
			networkType
		).setMaxFee(100);
		signedTx3 = alice.sign(tx3,generationHash);

		nodeFetch(nodeUrl + "/transactions","PUT",{"payload": signedTx.payload });
		nodeFetch(nodeUrl + "/transactions","PUT",{"payload": signedTx2.payload});
		nodeFetch(nodeUrl + "/transactions","PUT",{"payload": signedTx3.payload});

		addHistory("アドレス：" + address.plain());
		addHistory("ハッシュ：" + signedTx.hash);
		addHistory(`<a href='edit.html?confirm_id=${confirmId}&tx_id=${signedTx.hash}'>憲章エクスプローラー</a>`);

	},

	// onStatusChange 状態変更通知
	async function(event){
		console.log(event.name + " : " + event.error + " : " + event.targetNode);
	},

	// onPhysicalMessage QR受信時
	async function(event){

		console.log(event);
		$.toast({heading: 'Scan',text:event ,showHideTransition: 'plain',icon: 'info',});

		$('#modal_qr_scan').modal('hide');
	},

	async function(event     ){},	//onSocketMessage ソケット受信時
	async function(nodeSocket){},	//onSocketResumed ソケット接続回復時
	async function(){/* onVisible 画面フォーカス回復時     */}
);

</script>
</body>
</html>
